{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RoomSiftay</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

            <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
        </script>
  </head>

  <body class="bg-gray-100 flex flex-col min-h-screen">
    <div id="overlay" class="fixed inset-0 bg-black/40 hidden z-30"></div>

    <!-- ================= NAVBAR ================= -->
    <nav
      class="fixed top-0 z-50 w-full bg-[#112240] text-white px-6 py-4 flex items-center justify-between shadow-lg"
    >
      <!-- Left -->
      <div class="flex items-center gap-4">
        <button id="menuBtn" class="text-2xl focus:outline-none">
          <i class="fa-solid fa-bars"></i>
        </button>
        <span class="text-2xl font-bold tracking-tight">üè† RoomSiftay</span>
      </div>

      <!-- Right -->
      <div class="flex items-center gap-4">
        <!-- Right -->
        <div class="flex items-center gap-4">
          <!-- User Name -->
          <span class="text-sm text-gray-300">
            Welcome, {{ user.first_name|default:user.username }}
          </span>

          <!-- Avatar + Dropdown -->
          <div class="relative group cursor-pointer">
            <img
              src="{% if profile.profile_photo %}{{ profile.profile_photo.url }}{% else %}https://static.vecteezy.com/system/resources/previews/002/318/271/original/user-profile-icon-free-vector.jpg{% endif %}"
              class="w-10 h-10 rounded-full object-cover border border-white/40 shadow"
            />

            <!-- Dropdown menu -->
            <div
              class="absolute right-0 mt-3 w-48 bg-white text-gray-700 rounded-xl shadow-lg opacity-0 group-hover:opacity-100 invisible group-hover:visible transition-all duration-200"
            >
              <a
                href="{% url 'buyer_profile' %}"
                class="block px-4 py-3 hover:bg-gray-100 rounded-t-xl"
              >
                <i class="fa fa-user mr-2"></i> My Profile
              </a>

              <div class="border-t"></div>

              <a
                href="{% url 'logout' %}"
                class="block px-4 py-3 text-red-500 hover:bg-red-50 rounded-b-xl"
              >
                <i class="fa fa-right-from-bracket mr-2"></i> Logout
              </a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- ================= SIDEBAR ================= -->

    <aside
      id="sidebar"
      class="fixed top-0 left-0 z-40 w-64 h-screen pt-20 bg-[#112240] text-white transform -translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto"
    >
      <div class="px-4 py-2 border-b border-slate-700 mb-4">
        <p class="text-xs uppercase text-gray-500 font-bold tracking-widest">
          {% if request.session.mode == "owner" %} Owner Menu {% else %} Buyer
          Menu {% endif %}
        </p>
      </div>

      <ul class="px-2 space-y-1 text-sm">
        {% if request.session.mode == "buyer" %}
        <li>
          <a
            href="{% url 'buyer_dashboard' %}"
            class="flex items-center px-4 py-3 rounded-lg {% if request.resolver_match.url_name == 'buyer_dashboard' %}bg-blue-600{% else %}hover:bg-slate-800 text-gray-300{% endif %}"
          >
            <i class="fa-solid fa-chart-line mr-3"></i> Dashboard
          </a>
        </li>
        <li>
          <a
            href="{% url 'buyer_search_room' %}"
            class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-800"
          >
            <i class="fa-solid fa-magnifying-glass mr-3"></i> Search Rooms
          </a>
        </li>
        <li>
          <a
            href="{% url 'buyer_profile' %}"
            class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-800"
          >
            <i class="fa-solid fa-user mr-3"></i> My Profile
          </a>
        </li>
        <li>
          <a
            href="{% url 'saved_listings' %}"
            class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-800"
          >
            <i class="fa-solid fa-heart mr-3"></i> Saved Listings
          </a>
        </li>
        <li>
          <a
            href="{% url 'provide_review' %}"
            class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-800"
          >
            <i class="fa-solid fa-star mr-3"></i> Website Review
          </a>
        </li>
        <li>
          <a
            href="{% url 'report_issue' %}"
            class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-800"
          >
            <i class="fa-solid fa-flag mr-3"></i> Report Issue
          </a>
        </li>
        {% else %}
        <li>
          <a
            href="{% url 'owner_dashboard' %}"
            class="flex items-center px-4 py-3 rounded-lg {% if request.resolver_match.url_name == 'owner_dashboard' %}bg-blue-600{% else %}hover:bg-slate-800 text-gray-300{% endif %}"
          >
            <i class="fa-solid fa-chart-line mr-3"></i> Dashboard
          </a>
        </li>
        <li>
          <a
            href="{% url 'verification_page' %}"
            class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-800"
          >
            <i class="fa-solid fa-magnifying-glass mr-3"></i> Verification &
            Authentication
          </a>
        </li>
        <li>
          <a
            href="{% url 'owner_add_listingstep1' %}"
            class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-800"
          >
            <i class="fa-solid fa-heart mr-3"></i> Add New Listings
          </a>
        </li>
        <li>
          <a
            href="{% url 'owner_listing' %}"
            class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-800"
          >
            <i class="fa-solid fa-house-chimney mr-3"></i> My Listings
          </a>
        </li>
        <!-- TRASH LINK -->
        <li>
          <a
            href="{% url 'deleted_listing' %}"
            class="flex items-center justify-between px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-800"
          >
            <span class="flex items-center">
              <i class="fa-solid fa-trash-can mr-3"></i> Trash
            </span>
          </a>
        </li>
        <li>
          <a
            href="{% url 'buyer_profile' %}"
            class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-800"
          >
            <i class="fa-solid fa-user mr-3"></i> My Profile
          </a>
        </li>
        <li>
          <a
            href="{% url 'chat_list' %}"
            class="flex items-center px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-800"
          >
            <i class="fa-solid fa-comment-dots mr-3"></i> Chats with Buyers
          </a>
        </li>
        {% endif %}

        <div class="pt-4 mt-4 border-t border-slate-700">
          <li>
            <a
              href="{% url 'logout' %}"
              class="flex items-center px-4 py-3 rounded-lg text-red-400 hover:bg-red-500/10"
            >
              <i class="fa-solid fa-right-from-bracket mr-3"></i> Logout
            </a>
          </li>
        </div>
      </ul>
    </aside>

    <!-- ================= GLOBAL MESSAGES ================= -->
     {% block global_messages %}
    {% if messages %}
    <div class="fixed top-20 right-6 z-50 space-y-3 max-w-sm">
      {% for message in messages %}
      <div
        id="alert-msg-{{ forloop.counter }}"
        class="flex items-center gap-3 px-5 py-4 rounded-2xl shadow-lg border backdrop-blur-sm {% if message.tags == 'success' %} bg-green-50 text-green-800 border-green-200 {% elif message.tags == 'warning' %} bg-amber-50 text-amber-800 border-amber-200 {% elif message.tags == 'error' %} bg-red-50 text-red-800 border-red-200 {% else %} bg-blue-50 text-blue-800 border-blue-200 {% endif %}"
      >
        <i
          class="fas {% if message.tags == 'success' %}fa-check-circle text-green-500 {% elif message.tags == 'warning' %}fa-exclamation-triangle text-amber-500 {% elif message.tags == 'error' %}fa-times-circle text-red-500 {% else %}fa-info-circle text-blue-500{% endif %} text-lg"
        ></i>
        <span class="text-sm font-medium flex-1">{{ message }}</span>
        <button
          onclick="this.parentElement.remove()"
          class="opacity-60 hover:opacity-100 transition"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
      {% endfor %}
    </div>
    <script>
      setTimeout(() => {
        document.querySelectorAll('[id^="alert-msg-"]').forEach((el) => {
          el.style.transition = "all 0.3s ease";
          el.style.opacity = "0";
          el.style.transform = "translateX(20px)";
          setTimeout(() => el.remove(), 300);
        });
      }, 5000);
    </script>
    {% endif %}
      {% endblock %}


    <!-- ================= MAIN CONTENT ================= -->
    <main class="pt-24 px-8 flex-1">{% block content %} {% endblock %}</main>

    <!-- ================= SIDEBAR SCRIPT ================= -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const menuBtn = document.getElementById("menuBtn");
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");

        menuBtn.addEventListener("click", () => {
          sidebar.classList.remove("-translate-x-full");
          overlay.classList.remove("hidden");
        });

        overlay.addEventListener("click", () => {
          sidebar.classList.add("-translate-x-full");
          overlay.classList.add("hidden");
        });
      });
    </script>
 <!-- ================= ROOM SIFTAY AI ASSISTANT ================= -->

<!-- Toggle Button -->
<button id="chatToggle"
  class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-xl z-50">
  <i class="fa-solid fa-robot"></i>
</button>

<!-- Chat Window -->
<div id="chatWindow"
  class="fixed bottom-24 right-6 w-96 h-[520px] bg-white rounded-2xl shadow-2xl hidden flex flex-col overflow-hidden z-50 border">

  <!-- Header -->
  <div class="bg-[#112240] text-white px-4 py-3 flex justify-between items-center">
    <div>
      <h2 class="font-semibold text-sm">RoomSiftay Assistant</h2>
      <p class="text-xs text-gray-300">Smart Rental Guide</p>
    </div>

    <div class="flex items-center gap-3">
      <button onclick="clearChat()"
        class="text-xs bg-white/10 px-2 py-1 rounded hover:bg-white/20 transition">
        Clear
      </button>
      <button id="closeChat" class="text-gray-300 hover:text-white">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
  </div>

  <!-- Messages -->
  <div id="chatMessages"
    class="flex-1 overflow-y-auto p-4  bg-gray-50 text-sm scroll-smooth">
  </div>

  <!-- Typing Indicator -->
  <div id="typingIndicator"
    class="px-4 py-2 text-xs text-gray-500 hidden flex items-center gap-1">
    <span>Assistant is typing</span>
    <span class="typing-dot"></span>
    <span class="typing-dot"></span>
    <span class="typing-dot"></span>
  </div>

  <!-- Input -->
  <div class="p-3 border-t flex gap-2">
    <input id="chatInput"
      class="flex-1 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
      placeholder="Ask about rooms, prices, verification..." />
    <button onclick="sendMessage()"
      class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-lg text-sm">
      Send
    </button>
  </div>
</div>

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fadeIn {
  animation: fadeIn 0.25s ease-in-out;
}
.typing-dot {
  width: 4px;
  height: 4px;
  background: gray;
  border-radius: 50%;
  animation: blink 1.4s infinite both;
}
.typing-dot:nth-child(2) { animation-delay: .2s; }
.typing-dot:nth-child(3) { animation-delay: .4s; }

@keyframes blink {
  0% { opacity: .2; }
  20% { opacity: 1; }
  100% { opacity: .2; }
}
</style>

<script>
const chatToggle = document.getElementById("chatToggle");
const chatWindow = document.getElementById("chatWindow");
const closeChat = document.getElementById("closeChat");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const typingIndicator = document.getElementById("typingIndicator");

chatToggle.onclick = () => chatWindow.classList.toggle("hidden");
closeChat.onclick = () => chatWindow.classList.add("hidden");

let chatHistory = JSON.parse(localStorage.getItem("roomsiftay_chat")) || [];

if (chatHistory.length === 0) {
  addMessage("bot",
    "Hello üëã Welcome to RoomSiftay!\n\n" +
    "You can ask things like:\n" +
    "- room in pokhara\n" +
    "- cheapest room under 8000\n" +
    "- how to verify account\n" +
    "- show my saved listings"
  , false);
}

chatHistory.forEach(msg => {
  if (msg.type === "room_results") {
    renderRoomCards(msg.data, false);
  } else {
    addMessage(msg.sender, msg.text, false);
  }
});

function saveChat() {
  localStorage.setItem("roomsiftay_chat", JSON.stringify(chatHistory));
}

function clearChat() {
  localStorage.removeItem("roomsiftay_chat");
  chatHistory = [];
  chatMessages.innerHTML = "";
  addMessage("bot", "Chat cleared. How can I assist you today?", false);
}

function addMessage(sender, text, save = true) {
  const msgDiv = document.createElement("div");
  msgDiv.className = sender === "user" ? "flex justify-end" : "flex justify-start";

  msgDiv.innerHTML = `
    <div class="${
      sender === "user"
        ? "bg-blue-600 text-white"
        : "bg-white border text-gray-800"
    } px-4 py-2 rounded-2xl max-w-[75%]  shadow-sm animate-fadeIn">
      ${text}
    </div>
  `;

  chatMessages.appendChild(msgDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  if (save) {
    chatHistory.push({ sender, text, type: "text" });
    saveChat();
  }
}

function renderRoomCards(data, save = true) {
  const wrapper = document.createElement("div");
  wrapper.className = "flex justify-start";

  const container = document.createElement("div");
  container.className = "bg-gray-100 p-3 rounded-2xl space-y-3 max-w-[85%] animate-fadeIn";

  const header = document.createElement("div");
  header.className = "font-semibold text-blue-600 text-sm";
  header.innerText = `üè† Showing ${data.total} rooms in ${data.city}`;
  container.appendChild(header);

  data.listings.forEach(room => {
    const card = document.createElement("div");
    card.className =
      "bg-white rounded-xl shadow-sm p-3 hover:shadow-md transition border";

    card.innerHTML = `
      <h3 class="font-semibold text-base">${room.title}</h3>
      <p class="text-xs text-gray-500">üìç ${room.city}</p>
      <p class="text-blue-600 font-bold mt-1">Rs ${room.rent}</p>
      <a href="/buyer/listing/${room.id}/"
         class="inline-block mt-2 text-xs text-blue-500 hover:underline">
         View Details ‚Üí
      </a>
    `;

    container.appendChild(card);
  });

  wrapper.appendChild(container);
  chatMessages.appendChild(wrapper);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  if (save) {
    chatHistory.push({ type: "room_results", data });
    saveChat();
  }
}

async function sendMessage() {
  const message = chatInput.value.trim();
  if (!message) return;

  addMessage("user", message);
  chatInput.value = "";
  typingIndicator.classList.remove("hidden");

  try {
    const response = await fetch("/chatbot/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    });

    const data = await response.json();
    typingIndicator.classList.add("hidden");

    if (data.type === "room_results") {
      renderRoomCards(data);
    } else {
      addMessage("bot", data.message);
    }

  } catch (error) {
    typingIndicator.classList.add("hidden");
    addMessage("bot", "Something went wrong. Please try again.");
  }
}

chatInput.addEventListener("keypress", function(e) {
  if (e.key === "Enter") sendMessage();
});
</script>
  </body>
  {% include "footer.html" %}
</html>