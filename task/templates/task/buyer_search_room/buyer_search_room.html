{% extends "base.html" %}
{% block title %}Search Rooms{% endblock %}
{% block content %}

<form id="filtersForm" method="get" action="{% url 'buyer_search_room' %}" class="mb-10 space-y-5 ">

<!-- HEADER -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-6 ">

    <div>
        <h1 class="text-3xl font-bold">Find rooms</h1>
        <p class="text-gray-500">Search rooms by price or map</p>
    </div>

    <!-- SEARCH BAR -->
    <div class="relative w-full md:max-w-md">
        <input type="text" name="q" value="{{ q }}"
               placeholder="Search city or area"
               class="w-full pl-12 pr-4 py-3 rounded-full border shadow-md focus:ring-2 focus:ring-slate-900 outline-none">
        <i class="fa-solid fa-magnifying-glass text-gray-500 absolute left-4 top-1/2 -translate-y-1/2"></i>
    </div>

</div>

<!-- FILTER BAR -->
<div class="bg-white p-4 rounded-2xl border">
<div class="flex flex-wrap gap-3 items-center">

    <!-- SORT -->
    <div class="relative">
        <i class="fa-solid fa-filter absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
        <select name="sort"
            class="pl-11 pr-8 py-3 rounded-full border bg-white shadow-sm focus:ring-2 focus:ring-slate-900 outline-none appearance-none">
            <option value="">Sort</option>
            <option value="newest" {% if sort == "newest" %}selected{% endif %}>Newest</option>
            <option value="price_low" {% if sort == "price_low" %}selected{% endif %}>Price low → high</option>
            <option value="price_high" {% if sort == "price_high" %}selected{% endif %}>Price high → low</option>
        </select>
        <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-xs text-gray-500"></i>
    </div>

    <!-- MIN PRICE -->
    <div class="relative">
        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">Rs</span>
        <input type="number" name="min_price" value="{{ min_price }}"
            placeholder="Min price"
            class="pl-12 pr-4 py-3 rounded-full border shadow-sm focus:ring-2 focus:ring-slate-900 outline-none">
    </div>

    <!-- MAX PRICE -->
    <div class="relative">
        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">Rs</span>
        <input type="number" name="max_price" value="{{ max_price }}"
            placeholder="Max price"
            class="pl-12 pr-4 py-3 rounded-full border shadow-sm focus:ring-2 focus:ring-slate-900 outline-none">
    </div>

    <!-- ROOM TYPE -->
    <div class="relative">
        <i class="fa-solid fa-door-open absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
        <select name="room_type"
            class="pl-11 pr-8 py-3 rounded-full border bg-white shadow-sm focus:ring-2 focus:ring-slate-900 outline-none appearance-none">
            <option value="">Room type</option>
            <option value="private" {% if room_type == "private" %}selected{% endif %}>Private</option>
            <option value="entire" {% if room_type == "entire" %}selected{% endif %}>Entire</option>
            <option value="shared" {% if room_type == "shared" %}selected{% endif %}>Shared</option>
        </select>
        <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-xs text-gray-500"></i>
    </div>

    <!-- MAP -->
    <button type="button" id="openMapBtn"
        class="px-5 py-3 rounded-full border shadow-sm hover:bg-gray-100 transition">
        <i class="fa-solid fa-map mr-1"></i> Map
    </button>

    <!-- MY LOCATION -->
    <button type="button" id="useMyLocationBtn"
        class="px-5 py-3 rounded-full border shadow-sm hover:bg-gray-100 transition">
        <i class="fa-solid fa-location-crosshairs mr-1"></i> My location
    </button>

    <!-- APPLY -->
    <button type="submit"
        class="bg-slate-900 text-white px-6 py-3 rounded-full hover:bg-black transition shadow">
        Apply
    </button>

    <!-- CLEAR -->
    <button type="button" id="clearFiltersBtn"
        class="px-5 py-3 rounded-full border hover:bg-red-50 hover:border-red-400 transition">
        <i class="fa-solid fa-xmark mr-1"></i> Clear
    </button>

</div>
</div>

<input type="hidden" name="lat" id="latInput" value="{{ lat }}">
<input type="hidden" name="lng" id="lngInput" value="{{ lng }}">
<input type="hidden" name="radius_km" id="radiusInput" value="{{ radius_km|default:'3' }}">

</form>


<!-- MAP MODAL -->
<div id="mapModal" class="fixed inset-0 bg-black/50 hidden z-50 items-center justify-center">
    <div class="bg-white w-[90%] max-w-4xl rounded-xl overflow-hidden">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="font-semibold">Search through map</h3>
            <button id="closeMapBtn" class="text-xl hover:text-red-500">✕</button>
        </div>
        <div id="map" class="h-[500px]"></div>
        <div class="p-4 border-t text-right">
            <button id="applyMapFilterBtn"
                class="bg-slate-900 text-white px-5 py-2 rounded-lg hover:bg-black transition">
                Apply Map Filter
            </button>
        </div>
    </div>
</div>


<!-- LISTINGS GRID -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
{% for listing in listings %}
<div class="bg-white rounded-2xl shadow hover:shadow-xl transition overflow-hidden">
    {% with listing.photos.first as photo %}
        {% if photo %}
            <img src="{{ photo.image.url }}" class="h-56 w-full object-cover">
        {% else %}
            <div class="h-56 bg-gray-200 flex items-center justify-center">No Image</div>
        {% endif %}
    {% endwith %}
    <div class="p-5">
        <h3 class="font-semibold text-lg">{{ listing.title }}</h3>
        <p class="text-gray-500">{{ listing.city }}{% if listing.area %}, {{ listing.area }}{% endif %}</p>
        <p class="font-bold mt-2 text-lg">Rs. {{ listing.monthly_rent }}</p>
        <a href="{% url 'buyer_listing_detail' listing.id %}"
           class="inline-block mt-3 text-slate-900 font-semibold hover:underline">
            View details →
        </a>
    </div>
</div>
{% endfor %}
</div>

<script>
let map=null, marker=null, markers=[];

function openMap(){
    mapModal.classList.remove('hidden');

    setTimeout(()=>{
        if(!map){
            map=L.map('map').setView([28.2096,83.9856],12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            map.on('click',e=>{
                if(marker) marker.setLatLng(e.latlng);
                else marker=L.marker(e.latlng).addTo(map);

                latInput.value=e.latlng.lat.toFixed(6);
                lngInput.value=e.latlng.lng.toFixed(6);
            });

            /* LISTING MARKERS WITH IMAGE POPUP */
            {% for listing in listings %}
            {% if listing.latitude and listing.longitude %}
            markers.push(
                L.marker([{{listing.latitude}}, {{listing.longitude}}]).addTo(map)
                .bindPopup(`
                    <a href="{% url 'buyer_listing_detail' listing.id %}">
                        {% with listing.photos.first as photo %}
                            {% if photo %}
                                <img src="{{ photo.image.url }}"
                                     style="width:200px;height:140px;object-fit:cover;border-radius:12px;">
                            {% endif %}
                        {% endwith %}
                    </a>
                `)
            );
            {% endif %}
            {% endfor %}

            if(markers.length){
                const group=L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.2));
            }

        } else map.invalidateSize();
    },300);
}

openMapBtn.onclick=openMap;
closeMapBtn.onclick=()=>mapModal.classList.add('hidden');
applyMapFilterBtn.onclick=()=>filtersForm.submit();

useMyLocationBtn.onclick=function(){
    if(!navigator.geolocation){ alert("Geolocation not supported"); return; }

    navigator.geolocation.getCurrentPosition(pos=>{
        latInput.value=pos.coords.latitude.toFixed(6);
        lngInput.value=pos.coords.longitude.toFixed(6);
        filtersForm.submit();
    });
}

clearFiltersBtn.onclick=()=>window.location.href="{% url 'buyer_search_room' %}";
</script>

{% endblock %}
 