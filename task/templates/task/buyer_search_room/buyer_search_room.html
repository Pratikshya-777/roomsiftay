{% extends "base.html" %}
{% block title %}Search Rooms{% endblock %}

{% block content %}

<!-- Header -->
<div class="mb-10">
    <h1 class="text-4xl font-bold">Find rooms</h1>
    <p class="text-gray-500 mt-2">
        Verified rooms from trusted owners
    </p>
</div>

<!-- Search and Filters Form -->
<form id="filtersForm" method="get" action="{% url 'buyer_search_room' %}" class="mb-12 space-y-6">
    <!-- Search Bar -->
    <div class="relative max-w-xl">
        <input
            type="text"
            name="q"
            value="{{ request.GET.q }}"
            placeholder="Search city or area (Pokhara, Lakeside...)"
            class="w-full pl-12 pr-4 py-4 rounded-full border shadow-sm focus:ring-2 focus:ring-slate-900 outline-none"
        >
        <span class="absolute left-4 top-4 text-gray-400 text-xl">üîç</span>
    </div>

    <!-- Filters as Dropdowns -->
    <div class="flex flex-wrap gap-3">
        <!-- Location Dropdown -->
        <div class="relative">
            <button type="button" onclick="toggleDropdown('locationDropdown')" class="bg-white border px-4 py-2 rounded-lg shadow-sm flex items-center gap-2">
                Location
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="locationDropdown" class="hidden absolute z-10 mt-2 bg-white border rounded-lg shadow-lg p-4 w-64">
                <select name="location" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-900 outline-none mb-2">
                    <option value="">Select location</option>
                    <option value="Pokhara" {% if request.GET.location == 'Pokhara' %}selected{% endif %}>Pokhara</option>
                    <option value="Lakeside" {% if request.GET.location == 'Lakeside' %}selected{% endif %}>Lakeside</option>
                    <option value="Kathmandu" {% if request.GET.location == 'Kathmandu' %}selected{% endif %}>Kathmandu</option>
                    <option value="Butwal" {% if request.GET.location == 'Butwal' %}selected{% endif %}>Butwal</option>
                </select>
                <button type="button" class="text-sm text-blue-600 hover:underline">üìç Use my location</button>
            </div>
        </div>

        <!-- Price Range Dropdown -->
        <div class="relative">
            <button type="button" onclick="toggleDropdown('priceDropdown')" class="bg-white border px-4 py-2 rounded-lg shadow-sm flex items-center gap-2">
                Price Range
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="priceDropdown" class="hidden absolute z-10 mt-2 bg-white border rounded-lg shadow-lg p-4 w-64">
                <div class="flex gap-2 items-center">
                    <input type="number" name="min_price" id="min_price" value="{{ request.GET.min_price }}" placeholder="Min"
                        class="w-1/2 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-900 outline-none" oninput="updatePriceRange()">
                    <span>-</span>
                    <input type="number" name="max_price" id="max_price" value="{{ request.GET.max_price }}" placeholder="Max"
                        class="w-1/2 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-slate-900 outline-none" oninput="updatePriceRange()">
                </div>
                <div id="priceRangeDisplay" class="mt-2 text-sm text-gray-500"></div>
            </div>
        </div>

        <!-- Room Type Dropdown -->
        <div class="relative">
            <button type="button" onclick="toggleDropdown('roomTypeDropdown')" class="bg-white border px-4 py-2 rounded-lg shadow-sm flex items-center gap-2">
                Room Type
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="roomTypeDropdown" class="hidden absolute z-10 mt-2 bg-white border rounded-lg shadow-lg p-4 w-56">
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="radio" name="room_type" value="single" {% if request.GET.room_type == 'single' %}checked{% endif %} class="mr-2">
                        <span class="text-sm">Single Room</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="room_type" value="private" {% if request.GET.room_type == 'private' %}checked{% endif %} class="mr-2">
                        <span class="text-sm">Private Room</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="room_type" value="shared" {% if request.GET.room_type == 'shared' %}checked{% endif %} class="mr-2">
                        <span class="text-sm">Shared Room</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Apply Filters Button -->
        <button type="submit" class="bg-slate-900 text-white px-6 py-2 rounded-lg font-semibold hover:bg-slate-800">
            Apply Filters
        </button>
    </div>
</form>

<!-- Listings -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">

{% for listing in listings %}
<div class="bg-white rounded-2xl shadow hover:shadow-xl transition overflow-hidden">

    {% with listing.photos.first as photo %}
        {% if photo %}
            <img src="{{ photo.image.url }}" class="h-56 w-full object-cover">
        {% else %}
            <div class="h-56 bg-gray-200 flex items-center justify-center text-gray-400">
                No Image
            </div>
        {% endif %}
    {% endwith %}

    <div class="p-5">
        <h3 class="text-lg font-semibold">
            {{ listing.title }}
        </h3>

        <p class="text-sm text-gray-500">
            üìç {{ listing.city }}{% if listing.area %}, {{ listing.area }}{% endif %}
        </p>

        <p class="text-xl font-bold mt-2">
            Rs. {{ listing.monthly_rent }}
        </p>

        <div class="mt-4 flex justify-between items-center">
            <a href="{% url 'buyer_listing_detail' listing.id %}"
               class="font-semibold hover:underline">
                View ‚Üí
            </a>

            <a href="{% url 'save_listing' listing.id %}"
               class="text-xl hover:text-red-500">
                ‚ù§Ô∏è
            </a>
        </div>
    </div>
</div>
{% endfor %}

</div>

<script>
function updatePriceRange() {
    const min = document.getElementById('min_price').value;
    const max = document.getElementById('max_price').value;
    let text = '';
    if (min && max) {
        text = `Showing rooms from Rs. ${min} to Rs. ${max}`;
    } else if (min) {
        text = `Showing rooms from Rs. ${min}`;
    } else if (max) {
        text = `Showing rooms up to Rs. ${max}`;
    }
    document.getElementById('priceRangeDisplay').textContent = text;
}

function toggleDropdown(id) {
    document.querySelectorAll('.relative .absolute').forEach(el => {
        if (el.id !== id) el.classList.add('hidden');
    });
    const dropdown = document.getElementById(id);
    if (dropdown) dropdown.classList.toggle('hidden');
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.relative')) {
        document.querySelectorAll('.relative .absolute').forEach(el => el.classList.add('hidden'));
    }
});

// Initialize price range display on page load
window.addEventListener('DOMContentLoaded', updatePriceRange);
</script>

{% endblock %}
